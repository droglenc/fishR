```{r postblog, eval=FALSE, echo=FALSE}
## Run these commands when you are ready to push out to the fishR blog.
title <- "Merge Relational Dataframes"
cats <- c('Data Manipulation')
keys <- c('Data Manipulation')
setwd("C:/aaaWork/Web/fishR/BlogExamples")
source('WPSetup.R')
knit2wp("MergeRelationalDataframes.Rmd",publish=FALSE,shortcode=TRUE,
        title=title,categories=cats,mt_keywords=keys)
```

```{r setup, echo=FALSE, results='hide'}
# Having this separate from the setup file allows one to knit this in RStudio.
opts_chunk$set(dev="png",tidy=FALSE)
```

## A Question ##
Recently, a student, working on her Senior Thesis at [Northland College](http://www.northland.edu), asked me the following question:

> Attached is an Excel file with three "important to R" worksheets.  The only thing that connects all 3 worksheets is the Lift.ID variable.  Is there a way to tell R this so that I don't have to paste all three worksheets onto one new worksheet and then manually format the data so that there is one Lift.ID that connects the Count sheet info to the Lift sheet info?

## An Answer ##
Or course, the best answer to this (type of) question would be to teach this student how to use a relational database and generate a query.  Getting that into our curriculum is a discussion for another time (and venue).

However, as these data were fairly simple, her question can be completed in R with `merge()`.  I demonstrate this below with two practice data frames that each have a Lift.ID variable.  To test behavior, `df2` only had one species for `lift.ID==5` and neither species for `lift.ID==6`.  The data frames were constructed with (again, these are just example data, real data would be imported from an external file)

```{r}
( df1 <- data.frame(Lift.ID=1:6,
                    eff=c(3,4,2,5,1,1),
                    loc=c("A","B","A","C","B","D")) )
( df2 <- data.frame(Lift.ID=c(rep(1:4,each=2),5),
                    species=c(rep(c("LKT","PWF"),4),"LKT"),
                    catch=round(rnorm(9,mean=20,sd=3),0)))
```

These two data frames can be joined to form one data frame with `merge()` where the first two arguments are the two data frames (the first one is considered to be the "x" data frame) and the `by=` argument contains the name of the variable that links the data frames.  For example,

```{r}
( df.comb1 <- merge(df1,df2,by="Lift.ID") )
```

Thus, for example, the catch-per-unit-effort (CPE) for each lift could be appended with
```{r}
df.comb1$CPE <- df.comb1$catch/df.comb1$eff
df.comb1
```

## A Potential Problem ##
A potential problem exists if the student wanted to computed mean CPE by species.  For `species=="LKT"` the mean will not include a zero CPE for `Lift.ID==6` and for `species=="PWF"` the mean will not include zeroes for each of the last two lifts.

This problem can be corrected by first including the `all.x=TRUE` argument to `merge()` such that each row (lift) in the "x" data frame will be included in the combined data frame whether or not there is a corresponding row in the "y" data frame.  In other words, information about `Lift.ID==6` needs to be in the combined data frame.  For example, compare the following result of `merge()` to the previous result.

```{r}
( df.comb2 <- merge(df1,df2,by="Lift.ID",all.x=TRUE) )
```

However, this still does not completely solve the problem because there are no "zeroes" for catches.  The "zeroes" can be added to the dataframe with `addZeroCatch()` from the **FSA** package.  First, load the **FSA** package

```{r results='hide', warning=FALSE, message=FALSE}
library(FSA)
```

The `addZeroCatch()` function requires the original data frame as the first argument, the name of the variable that defines the sampling event (i.e., a net lift) in the `eventvar=` argument, the variabile that identifies the species caught in the `speciesvar=` argument, and the variable that should receive the zeroes in the `zerovar=` argument.  For example,
```{r}
( df.comb2 <- addZeroCatch(df.comb2,eventvar="Lift.ID",
                           specvar="species",zerovar="catch") )
```

The last remaining problem is the row with the `NA`s that was created when the `all.x=TRUE=` argument was used (see row 10 above).  This row (and if there were more rows like it) can be removed as follows
```{r}
( df.comb2 <- subset(df.comb2,!is.na(catch)) )
```

Now the summary statistics for CPE for each species can be computed (note that `Summarize()` is from **FSA**).
```{r}
df.comb2$CPE <- df.comb2$catch/df.comb2$eff
( Summarize(CPE~species,data=df.comb2,digits=2) )
```
Compare these to the incorrect values from the first use of `merge()`.
```{r}
( Summarize(CPE~species,data=df.comb1,digits=2) )
```