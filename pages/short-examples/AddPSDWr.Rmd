---
title: "Efficiently Adding Gabelhouse Lengths and Relative Weights to a data.frame (using dplyr)"
author: "Derek H. Ogle"
date: "October 7, 2014"
output: html_document
---

```{r setup, echo=FALSE, results='hide'}
library(knitr)
# Having this separate from the setup file allows one to knit this in RStudio.
knit_hooks$set(par1 = function(before, options, envir) {
  if (before) par(mar=c(3.5,3.5,2,2),mgp=c(2.1,0.4,0),tcl=-0.2)
})
opts_chunk$set(dev="png",tidy=FALSE,par1=TRUE)
```

## Introduction
Fisheries scientists often compute proportional stock distribution (PSD) and relative weight (Wr) indices (see [here](https://sites.google.com/site/fishrfiles/home/ifswr-drafts/SizeStructure_IntroFishScience.pdf) and [here](https://sites.google.com/site/fishrfiles/gnrl/RelativeWeight.pdf) for more details).  Proportional stock indices require the construction of a variable that contains the Gabelhouse length categories (i.e., "stock", "quality", "preferred", "memorable", "trophy") derived from observed lengths.  Computation of relative weights requires that a variable that contains the standard weight for the fish be constructed.  The Gabelhouse length categories and standard weight equations are species-specific and, thus, past implementations required that application of the categories or standard weight equations occur on a species-by-species basis.  In other words, if a fisheries scientists wanted to create these variables for several species in a data.frame then he or she would have to subset the data.frame by a single species and then apply the categories or formula to that subsetted data.frame.  This would be repeated for each species.

I recently modified or added two functions to the **[FSA](http://fishr.wordpress.com/fsa/)** package that, when coupled with functions in the **dplyr** package, can efficiently create the length categorization and relative weight variables for all species in a data.frame without having to subset that data.frame.  These two functions are illustrated below.

First, I loaded the **FSA** and **dplyr** packages for use below.
```{r results='hide', warning=FALSE, message=FALSE}
library(FSA)
library(dplyr)
```


## Some Data
The `InchLake2` data.frame in the **FSAdata** package contains the observed lengths and weights for several species of fish from an inland lake in Wisconsin.
```{r warning=FALSE, message=FALSE}
library(FSAdata)
data(InchLake2)
str(InchLake2)
```

The lengths were measured in inches and the weights were recorded in grams.  The lengths were converted to mm so that the two measures would be in the same type of units.  For display purposes below, I also sorted the data.frame by species and length and removed variables that were not needed for this post.

```{r}
InchLake2 <- InchLake2 %>%
  mutate(tl=round(length*25.4,0)) %>%
  arrange(species,tl) %>%
  select(-netID,-fishID,-year,-length)
head(InchLake2)
```

## The New Functions
The new function that adds the Gabelhouse length categories is ``psdAdd()``.  When used with ``mutate()`` from **dplyr**, ``psdAdd()`` takes vectors of the length and species names as the first two arguments.
```{r}
InchLake2 <- mutate(InchLake2,gcat=psdAdd(tl,species))
InchLake2[seq(1,501,50),] # Examine every 50th row
```

From these results, it is seen that a new variable, called `gcat` contains the length category names for all species for which Gabelhouse length categoies exist, an `NA` appears for those species for which Gabelhouse length categories do not exist; e.g., Bluntnose Minnow and Iowa Darter), and the category name is "zero" if the fish's length is below the stock value.

``psdAdd()`` assumes that metric (mm and g) units are used and that the user wants names for the Gabelhouse categories (e.g., "stock", "quality", etc.) in the resulting variable.  If the data were recorded in English units (inches and lbs) then use ``units='English'``.  The minimum values for the categories, illustrated below, will be used if ``use.names=FALSE``.

```{r}
InchLake2 <- mutate(InchLake2,gcatv=psdAdd(tl,species,use.names=FALSE))
InchLake2[seq(1,501,50),] # Examine every 50th row
```

The ``wrAdd()`` function is used to add a variable with the relative weights for each species.  When used with ``mutate()`` it requires vectors of observed weights, lengths, and species names as the first three arguments.   As with ``psdAdd()``, ``wrAdd()`` assumes metric units (mm and g) but can use English units (inches and lbs) with ``units="metric"``.
```{r}
InchLake2 <- mutate(InchLake2,Wr=wrAdd(weight,tl,species))
InchLake2[seq(1,501,50),] # Examine every 50th row
```

``wrAdd()`` will not compute a relative weight if the length is less than the minimum or more than the maximum length for which the standard weight should be applied for a species.  This can be seen on the second line above where the relative weight for the 41 mm Bluegill is shown as `NA`.  The relative weight value for species without a known standard weight equation will also be `NA`.

## Limitations
These functions are both general and new and, thus, have some limitations.  Both functions require that the species names be recorded as they appear in `PSDlit` and `WRlit`, the databases of Gabelhouse lengths and standard weight equations in **FSA**.  The species names in these datafiles are full names and, thus, species codes, as are commonly used by many agencies, cannot be used.  However, `recodeF()` in **FSA** or `recode` in **car** can be used to efficiently create a new variable that converts "non-standard" species names to names accepted by `psdAdd()` and `wrAdd()`.

Currently, `psdAdd()` can only be used to add Gabelhouse length categories.  Thus, the user currently cannot use a length interval different than what has been defined in the literature for a particular species.

Currently `wrAdd()` only uses standard weight equations that have been constructed for the 75th percentile of mean lengths.  While the vast majority of standard weight equations use the 75th percentile, some recent equations for some species include other percentiles.  These other percentiles cannot be used with `wrAdd()`.

## Simple Summaries
The incremental and traditional PSD calculations for all species are constructed most efficiently by first removing all of the sub-stock fish (labeled with "zero") and all individuals where the length categorization value is `NA` (i.e., removes species without Gabelhouse length categories).  Use `droplevels()` to remove "zero" and the unused species from the list of possible levels.
```{r}
Inch4PSD <- InchLake2 %>%
  filter(gcat!="zero") %>%
  mutate(gcat=droplevels(gcat)) %>%
  filter(!is.na(gcat)) %>%
  mutate(species=droplevels(species))
```

The incremental PSD values are then computed, for all species where these calculations are possible, as follows.
```{r}
freq <- xtabs(~species+gcat,data=Inch4PSD)
iPSDs <- prop.table(freq,margin=1)*100
round(iPSDs,1)
```
Thus, for example `r formatC(iPSDs["Black Crappie","stock"])`% of Black Crappies are between stock- and quality-length (this is PSD S-Q) and `r formatC(iPSDs["Pumpkinseed","preferred"])`% of Pumpkinseeds are between preferred- and memorable-length (this is PSD P-M).

The traditional PSD values are then computed as follows
```{r}
PSDs <- t(apply(iPSDs,MARGIN=1,FUN=rcumsum))
round(PSDs,1)
```
Thus, for example `r formatC(PSDs["Black Crappie","quality"])`% of stock-length Black Crappies are quality-length (or greater; i.e., this is the PSD) and `r formatC(PSDs["Pumpkinseed","preferred"])`% of stock-length Pumpkinseeds are preferred-length (or greater; this is PSD-P).

Descriptive statistics for the relative weights of each species can be quickly computed with `Summarize()` from **FSA**.
```{r}
Summarize(Wr~species,data=InchLake2,digits=1)
```

Descriptive statistics for the relative weights of each species by Gabelhouse length category can be computed with `Summarize()`.
```{r}
Summarize(Wr~gcat*species,data=InchLake2,digits=1)
```

## Relation to Other Posts
[In earlier posts](http://fishr.wordpress.com/2014/09/28/updated-dplyr-examples/), I briefly introduced the "verbs" in the **dplyr** package and showed how to use `lencat()` from **FSA** with `mutate()` from **dplyr**.
