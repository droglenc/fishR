```{r postblog, eval=FALSE, echo=FALSE}
## Run these commands when you are ready to push out to the fishR blog.
library(knitr)
title <- "A Problem Fitting the von Bertalanffy Growth Model with nls()"
cats <- c('R','Fisheries Science')
keys <- c('R','Growth','von Bertalanffy')
setwd("C:/aaaWork/Web/fishR/BlogExamples")
source('WPSetup.R')
knit2wp("vonBProblem1.Rmd",publish=FALSE,shortcode=TRUE,
        title=title,categories=cats,mt_keywords=keys)
#NOTE that I had to manually edit the equations in wordpress.
```

```{r setup, echo=FALSE, results='hide'}
# Having this separate from the setup file allows one to knit this in RStudio.
opts_chunk$set(dev="png",tidy=FALSE)
```

Recently, a [fishR](http://fishr.wordpress.com/) user asked me the following (modified) question:

> I have successfully fit the typical von Bertalanffy growth model to all of my fish.  However, when I subset the data by sex and attempt to fit the model separately to males and females I receive an 'infinity' and 'singular gradient' error.  Why does this happen and is there anything I can do about it?

The user sent me their data which I use below to confirm the problem stated above and to describe some observations that I have made from fitting many von Bertalanffy growth models (VBGMs).

## Preliminaries and Data Manipulation ##
I begin by loading the **FSA** package ...

```{r results='hide', warning=FALSE, message=FALSE}
library(FSA)
```

... and the data (note that the working direction would have been set before `read.csv()`) ...

```{r}
df <- read.csv("BKData.csv",header=TRUE)
str(df)
levels(df$Sex)
```

(**Note:** *A blank is a poor way to code for "unknown" sex individuals.*)

I separated the data into three data frames corresponding to male, female, and unknown sexed individuals ...

```{r}
df_M <- Subset(df,Sex=="Male")
dim(df_M)
df_F <- Subset(df,Sex=="Female")
dim(df_F)
df_U <- Subset(df,Sex=="")
dim(df_U)
```


## Fitting the Typical Von Bertalanffy Model to All Fish ##

I illustrate the fitting of the typical VBGM by using the `vbFuns()` convenience function in the **FSA** package.  This function requires the "name" of the VBGM as its only argument and returns a function that can be used to compute fish length from age given parameter values for that model.

```{r}
( vbT <- vbFuns("typical") )
```

The `vbStarts()` function is used to find reasonable starting values for a particular version of the VBGM.  This function requires a formula containing the length and age data, a data frame in `data=`, and the "name" of the VBGM parameterization in `type=`.

```{r}
( svTall <- vbStarts(Length~Age,data=df,type="typical") )
```

The VBGM is fit with `nls()` where a formula is the first argument that has the length variable on the right-hand-side and the model function saved from `vbFuns()` as the left-hand-side where that function has the age variable as its first argument followed by the names of the parameters as the remaining arguments.  The `nls()` function also requires a data frame in `data=` and the list of starting values in `start=`.

```{r}
fitAll <- nls(Length~vbT(Age,Linf,K,t0),data=df,start=svTall)
summary(fitAll)
```

A quick fit of the model can be seen with
```{r VBGMfit, fig.width=4, fig.height=4}
plot(Length~Age,data=df,pch=16,xlab="Age",ylab="Total Length (mm)")
curve(vbT(x,Linf=coef(fitAll)),from=0,to=19,col="red",lwd=2,add=TRUE)
```

## Fitting the Typical VBGM Separately to Males and Females ##

A similar process can be followed for fitting the typical VBGM to females ...

```{r}
svTF <- vbStarts(Length~Age,data=df_F,type="typical")
fitTF <- nls(Length~vbT(Age,Linf,K,t0),data=df_F,start=svTF)
```

... but an error occurs.  Similarly for males ...

```{r}
svTM <- vbStarts(Length~Age,data=df_M,type="typical")
fitTM <- nls(Length~vbT(Age,Linf,K,t0),data=df_M,start=svTM)
```

So, what happened?  A plot separated by sex is instructive ...

```{r MFdata, fig.width=4, fig.height=4}
plot(Length~Age,data=df_F,pch=16,xlab="Age",ylab="Total Length (mm)",
     xlim=c(1,19),ylim=c(200,750))
points(Length~Age,data=df_M,pch=16,col="red")
points(Length~Age,data=df_U,pch=15,col="blue")
legend("bottomright",c("Female","Male","Unknown"),pch=c(16,16,15),
       col=c("black","red","blue"),cex=0.75)
```

From this it is seen that all of the fish less than age-3 were of "unknown" sex.  Thus, when the data frame was reduced to just males or just females there were no fish less than age-3.  Additionally, no female fish were less than age-6, only two female fish were older than age-12, and no males were older than age-11.  In other words, when the data were subsetted, the age range of each subset was substantially narrowed.

Furthermore, over these constrained age ranges, the relationship between length and age for both females and males was largely linear.  In other words, there is no distinctive curve towards the origin at "young" ages and no obvious asymptote at "older" ages.  In addition, there is considerable variability in lengths within a given age (e.g., the lengths for age-6 range from approximately 350 to 625 mm).

These observations largely explain why the typical von Bertalanffy model does not "converge" properly for these subsets of data.  In layman's terms, it is very hard to fit a curved relationship to data with a largely linear relationship coupled with a high degree of natural (i.e., individual) variability.


## An Alternative VBGM Helps ##

Two of the known problems with the typical parameterization of the VBGM is that the parameters are highly correlated (knowing $L_{\infty}$ is very close to knowing $K$) and the parameters are often on very different scales ($L_{\infty}$ might be well into the 100s where as $K$ is usually between 0 and 1).  These problems are exacerbated with the data issues identified in the previous problem.  As described in the [Von Bertalanffy Growth - Intro Vignette](http://fishr.wordpress.com/vignettes/) on the fishR webpage, Francis (1988) reparameterized the traditional VBGM to have three parameters that are predicted lengths at three ages where the youngest and oldest age are chosen by the user and the third age is exactly between the two chosen ages.  The Francis parameterization has the benefit of having parameters that are less correlated and have similar scales.  Thus, the Francis parameterization is more likely to fit with the data issues presented here.  On the down-side, the Francis parameterization will not provide estimates of the usual $L_{\infty}$, $K$, and $t_{0}$ parameters.  However, one can still predict mean lengths-at-age (thus, "growth" can be described) and compare growth between groups.

The Francis parameterization is defined with ...

```{r}
( vbF <- vbFuns("Francis") )
```

... and the "young" and "old" agea that I chose to model with are defined with ...

```{r}
ages <- c(3,12)
```

The model is fit to the female data (without an error) with ...

```{r}
( svFF <- vbStarts(Length~Age,data=df_F,type="Francis",tFrancis=ages,methEV="poly") )
fitFF <- nls(Length~vbF(Age,L1,L2,L3,t1=ages),data=df_F,start=svFF)
summary(fitFF)
```

The model is fit to the male data (without an error) with ...

```{r}
svFM <- vbStarts(Length~Age,data=df_M,type="Francis",tFrancis=ages,methEV="poly")
fitFM <- nls(Length~vbF(Age,L1,L2,L3,t1=ages),data=df_M,start=svFM)
summary(fitFM)
```

The two fits can be visualized with ...

```{r VBGMfit2, fig.width=4, fig.height=4}
plot(Length~Age,data=df_F,pch=16,xlab="Age",ylab="Total Length (mm)",
     xlim=c(1,19),ylim=c(200,750))
points(Length~Age,data=df_M,pch=16,col="red")
legend("bottomright",c("Female","Male"),pch=16,col=c("black","red"),cex=0.75)
curve(vbF(x,L1=coef(fitFF),t1=ages),from=3,to=12,lwd=2,add=TRUE)
curve(vbF(x,L1=coef(fitFM),t1=ages),from=3,to=12,lwd=2,col="red",add=TRUE)
```

Further details of fitting this VBGM and methods for constructing bootstrap confidence intervals and developing models to compare parameters between groups are described in the [Von Bertalanffy Growth - Intro Vignette](http://fishr.wordpress.com/vignettes/) on the fishR webpage.